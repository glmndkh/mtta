You are a senior Node.js/Express engineer. The app already has a working password-based registration. DO NOT break it.

Goal:
Add a NEW, parallel “Verified Registration (Beta)” flow NEXT TO the existing one (Option B). Ship it feature-flagged, zero-downtime, fully reversible. Use dev fallbacks if external keys are missing.

Key requirements:
- Keep existing /register (password flow) 100% unchanged.
- New flow lives under /v2/* with minimal UI + pages.
- Feature flags:
  - REG_V2_ENABLED=true  (show/hide the whole /v2 flow)
  - STRICT_VERIFICATION_MODE=false  (if true → require admin approval too)
- External services OPTIONAL:
  - Email: SendGrid if SENDGRID_API_KEY set; else Nodemailer/Ethereal (print preview URL to console)
  - SMS: Twilio if TWILIO_* set; else console stub (log OTP)
  - Google OAuth (optional if GOOGLE_* set)

Tech stack:
- Node.js + Express
- better-sqlite3 (SQLite)
- cookie-session
- helmet, cors, express-rate-limit
- joi or express-validator
- multer for file upload (verification image)
- dotenv
- nodemailer (Ethereal dev) + SendGrid (prod if key present)
- Twilio (prod if keys present)
- passport-google-oauth20 (optional for /v2 Google sign-in)

.env (create .env and .env.example):
REG_V2_ENABLED=true
STRICT_VERIFICATION_MODE=false
APP_URL=https://<your-repl>.replit.app
PORT=3000
SESSION_SECRET=change-me
DATABASE_FILE=./data/app.sqlite
# Email
SENDGRID_API_KEY=
FROM_EMAIL=noreply@yourdomain.com
# SMS
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
TWILIO_FROM_NUMBER=
# Google (optional)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
OAUTH_CALLBACK_URL=https://<your-repl>.replit.app/v2/auth/google/callback
# Domain allow (optional)
ALLOWED_EMAIL_DOMAIN=
# Admin
ADMIN_EMAIL=admin@yourdomain.com
ADMIN_SECRET=<long-random>
OTP_TTL_SECONDS=300

Database (non-breaking; keep existing tables intact):
- NEW table pending_registrations_v2:
  id (uuid), name, email, phone, password_hash (nullable),
  uploaded_filename (nullable),
  email_verified integer default 0,
  phone_verified integer default 0,
  admin_approved integer default 0,
  email_token_hash text, email_token_exp integer,
  otp_hash text, otp_exp integer,
  status text default 'pending',        -- pending|rejected|completed
  created_at integer, updated_at integer,
  meta json
- NEW table audit_logs_v2:
  id (uuid), pending_id text, event_type text, data json, created_at integer
- Activation inserts into the EXISTING users table (respect unique email/phone).

Routes to ADD (do not remove/modify existing auth/signup):
UI
- GET /v2/register
  - Simple “Баталгаажуулсан бүртгэл (Бета)” form: name, email, phone, password (optional),
    verification image upload (jpg/png/pdf, max 5MB)
  - Show info: “Имэйл + утас баталгаажсаны дараа идэвхжинэ”
- GET /v2/success, /v2/error  (Mongolian messages/screens)
- (Optional) GET /v2/login-google button if GOOGLE_* provided

API
- POST /v2/register (multipart/form-data)
  Steps:
  1) Validate inputs (joi/express-validator). Normalize email/phone.
  2) If ALLOWED_EMAIL_DOMAIN set → enforce domain.
  3) Create pending row (NOT users), status='pending'.
  4) Generate email token (48 bytes hex) → store SHA256 hash + exp (now+24h).
  5) Generate OTP (6 digits) → store SHA256 hash + exp (now+OTP_TTL_SECONDS).
  6) Save uploaded file with multer (random filename).
  7) Send verification email to user:
     ${APP_URL}/v2/verify-email?token=RAW&pid=PENDING_ID
     - If SENDGRID_API_KEY missing → use Ethereal and print preview URL to console.
     - Email body in Mongolian with clear button and expiry text.
  8) Send SMS OTP to phone:
     - Twilio if keys present, otherwise console.log("OTP for <phone>:", code).
  9) Notify ADMIN_EMAIL by email with a secure review link:
     ${APP_URL}/v2/admin/review?pid=PENDING_ID&key=ADMIN_SECRET
     Include the uploaded image as attachment or link.
  10) Return JSON { status:'pending', message:'Бүртгэл хүлээгдэж байна. Имэйл болон утсаа баталгаажуулна уу.' }

- GET /v2/verify-email?token&pid
  - Verify token hash + exp; if ok set email_verified=1; audit log it.
  - If activation conditions met (see “Activation rule”) → create user in existing users table and mark pending as completed.
  - Render Mongolian HTML: next steps (e.g., “Утасны OTP-г баталгаажуулна уу” / “Админы зөвшөөрөл хүлээгдэж байна”).

- POST /v2/verify-phone  (JSON { pid, otp })
  - Check OTP hash + exp; if ok set phone_verified=1; audit log it.
  - If activation conditions met → finalize user (see below).
  - Return JSON with friendly Mongolian messages.

- Admin review (minimal):
  - GET /v2/admin/review?pid&key=ADMIN_SECRET
     Show pending details + image, buttons Approve/Reject.
  - POST /v2/admin/approve  (body: pid, key)
     Set admin_approved=1; if activation conditions met → finalize user.
     Send “Бүртгэл амжилттай” email to user (and SMS optional).
  - POST /v2/admin/reject  (body: pid, key, reason)
     status='rejected'; send rejection email with reason.

Optional Google for v2:
- GET /v2/auth/google → scopes ["openid","email","profile"] with state param
- GET /v2/auth/google/callback → accept ONLY if email_verified=true (from ID token/ profile._json)
  If ALLOWED_EMAIL_DOMAIN set, enforce domain.
  Store email/name/pic in the SAME pending row (if flow started) or create one.

Activation rule:
- When to insert into existing users table:
  - If STRICT_VERIFICATION_MODE=false: require email_verified && phone_verified
  - If STRICT_VERIFICATION_MODE=true: require email_verified && phone_verified && admin_approved
- On activation:
  - Upsert into existing users table (respect unique constraints).
  - Set activated_at (if column exists) and pending.status='completed'.
  - Send final success email + optional SMS confirmation.
  - Never activate on partial steps.

Security:
- Hash all tokens/OTPs with SHA256; single-use and mark used on success.
- Rate limit: /v2/register and /v2/verify-phone (e.g., 5/min/IP).
- helmet(), cors({ origin: APP_URL, credentials: true }), app.set('trust proxy', 1).
- multer: restrict to jpg/png/pdf; max 5MB; random filenames.
- All user-facing text must be in Mongolian; logs can be English.

Acceptance checklist (must pass before merge):
1) Existing password signup works exactly as before.
2) With REG_V2_ENABLED=true, /v2/register is visible; with false, hidden.
3) Submitting /v2/register creates a pending row only; no users row yet.
4) Email link flips email_verified=1; OTP flips phone_verified=1.
5) Admin approve (if STRICT=true) completes activation and inserts into existing users.
6) All emails sent (SendGrid if key, else Ethereal link in console). SMS sent (Twilio if keys, else console).
7) Uploaded image visible in admin page and in admin email.
8) Success/error pages and API JSON use Mongolian messages.
9) On server start, print a short README: how to toggle flags, where to find Ethereal preview URLs, and how to test E2E.

Deliverables:
- Code: /v2/routes.js, /v2/admin.js, /db.js (migrations), /views/*.html, /public/*
- Keep existing files and routes untouched.
- README.md with setup & testing steps.
- examples/curl.http with test calls.
- package.json scripts: "start": "node server.js", "dev": "nodemon server.js"

Now implement all of the above. If a choice is needed, prefer stability, backward-compatibility, and minimal UI surface area.
